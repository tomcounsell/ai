# Setup - New Machine Configuration

Configure this machine to run the Valor Telegram bridge. You do everything except the interactive Telegram login step.

## Prerequisites

Before starting, confirm the user has:
- Python 3.11+ installed
- The `ai` repo cloned at `/Users/valorengels/src/ai`
- Telegram API credentials (api_id and api_hash from https://my.telegram.org). If they don't have these, pause and explain how to get them before continuing.

## Step 1: Virtual Environment & Dependencies

```bash
cd /Users/valorengels/src/ai
```

Create the virtual environment if it doesn't exist, then install all dependencies **into the venv** (never user-site):

```bash
python3 -m venv .venv       # skip if .venv/ already exists
source .venv/bin/activate
.venv/bin/pip install -e .
```

Always use `.venv/bin/pip` and `.venv/bin/python` explicitly to guarantee packages land in the venv, not in `~/.local` or system site-packages.

Verify key imports work using the venv python:

```bash
.venv/bin/python -c "import telethon; import httpx; import dotenv; print('Dependencies OK')"
```

If this fails, debug before continuing.

## Step 2: Environment File (.env)

Check if `.env` exists. If not:

```bash
cp .env.example .env
```

**Ask the user** which project(s) this machine should monitor. The available projects are defined in `config/projects.json` — check the full list there. Common options:
- Single project: `ACTIVE_PROJECTS=psyoptimal`
- Multiple: `ACTIVE_PROJECTS=valor,popoto`
- All: `ACTIVE_PROJECTS=valor,django-project-template,popoto,psyoptimal,flutter-project-template,cuttlefish,yudame-research`

Edit `.env` and ensure these are set:

| Variable | Required | Notes |
|----------|----------|-------|
| `ACTIVE_PROJECTS` | Yes | Comma-separated project keys |
| `USE_CLAUDE_SDK` | Yes | Must be `true` |
| `ANTHROPIC_API_KEY` | Yes | Starts with `sk-ant-` |
| `TELEGRAM_API_ID` | Yes | Numeric, from my.telegram.org |
| `TELEGRAM_API_HASH` | Yes | Hex string, from my.telegram.org |
| `TELEGRAM_PHONE` | Yes | With country code, e.g. `+1234567890` |
| `TELEGRAM_PASSWORD` | If 2FA on | Telegram 2FA password |
| `TELEGRAM_SESSION_NAME` | No | Defaults to `valor_bridge` |
| `TELEGRAM_DM_WHITELIST` | No | Comma-separated names, e.g. `Tom` |

If any required values are placeholder/missing, ask the user to provide them. The shared API keys file at `/Users/valorengels/src/.env` may have `ANTHROPIC_API_KEY` and other keys — check there first.

## Step 3: Calendar Configuration

Set up Google Calendar integration for work time tracking.

1. **Ensure PATH includes pip script directory:**
   ```bash
   if ! grep -q 'Library/Python/3.12/bin' ~/.zshrc 2>/dev/null; then
     echo 'export PATH="$HOME/Library/Python/3.12/bin:$PATH"' >> ~/.zshrc
   fi
   export PATH="$HOME/Library/Python/3.12/bin:$PATH"
   ```

2. **Install dependencies** (if not already done in Step 1):
   ```bash
   pip3 install google-auth-oauthlib google-api-python-client --quiet
   ```

3. **Check for Google OAuth credentials:**
   ```bash
   ls ~/Desktop/claude_code/google_credentials.json
   ```
   If missing, ask the user to download OAuth client credentials from Google Cloud Console (project: Yudame General) and place at `~/Desktop/claude_code/google_credentials.json`.

4. **Run initial OAuth consent** (if no token exists):
   ```bash
   ls ~/Desktop/claude_code/google_token.json 2>/dev/null
   ```
   If no token, run `valor-calendar test` — this will open a browser for Google OAuth consent. The user must complete this in their browser.

5. **Create calendar config** at `~/Desktop/claude_code/calendar_config.json`:

   The calendar config is auto-generated by the `/update` command (step 8). Run `/update` after setup to generate it, or create it manually following these rules:

   **Calendar mapping rules:**
   - `"dm"` → `"primary"` (DMs go to the user's main Google Calendar)
   - `"default"` → calendar named **"Internal Projects"** (catch-all for Claude Code sessions and unmatched slugs)
   - Project-specific: each project's Telegram group name (minus the `"Dev: "` prefix) should match a Google Calendar name

   If the Google Calendar names don't exist yet, create them in Google Calendar first, then run `/update` to auto-generate the config.

## Step 4: Project Configuration (config/projects.json)

Check if `config/projects.json` exists. If not:

```bash
cp config/projects.json.example config/projects.json
```

Edit `config/projects.json` for this machine's projects.

**Critical rules when editing projects.json:**

1. **Every project MUST have `working_directory`** — absolute path to the repo on this machine
2. **Always include the full `defaults` section** — copy it from the example if missing
3. **DO NOT set `respond_to_all: false`** — the default is `true`, which is correct. Omit the field entirely from project-level telegram config.
4. **Keep project telegram config minimal** — usually just `"groups": ["Dev: ProjectName"]` is sufficient
5. **Verify paths exist on disk** — run `ls` on each `working_directory` to confirm

Example minimal project entry:

```json
{
  "projects": {
    "myproject": {
      "name": "My Project",
      "working_directory": "/Users/valorengels/src/myproject",
      "telegram": {
        "groups": ["Dev: My Project"]
      },
      "github": {
        "org": "orgname",
        "repo": "reponame"
      },
      "context": {
        "tech_stack": ["Python"],
        "description": "What the agent should focus on"
      }
    }
  },
  "defaults": {
    "working_directory": "/Users/valorengels/src/ai",
    "telegram": {
      "respond_to_all": true,
      "respond_to_mentions": true,
      "respond_to_dms": true,
      "mention_triggers": ["@valor", "valor", "hey valor"]
    },
    "response": {
      "typing_indicator": true,
      "max_response_length": 4000,
      "timeout_seconds": 300
    }
  }
}
```

If the project is already defined in the main repo's `config/projects.json`, copy its entry rather than writing from scratch. The canonical project list is in the main repo on the `main` branch.

After editing, verify all working directories exist:

```bash
# For each project's working_directory, confirm it exists
ls /Users/valorengels/src/<project_dir>
```

## Step 5: Telegram Login (USER ACTION REQUIRED)

Check for an existing session:

```bash
ls data/*.session 2>/dev/null
```

**If a session file exists**: Skip to Step 6.

**If no session file exists**: The user must complete an interactive login. Tell them:

> I've finished all the automated setup. One step requires your input — the Telegram login sends a verification code to your phone.
>
> Please run this in a terminal:
> ```
> cd /Users/valorengels/src/ai && source .venv/bin/activate && python scripts/telegram_login.py
> ```
> Let me know when you're done.

**STOP HERE. Do not proceed until the user confirms the login is complete.**

After they confirm, verify the session was created:

```bash
ls data/*.session
```

If no session file appeared, something went wrong. Ask the user what happened and help debug.

## Step 6: Start the Bridge

Ensure the logs directory exists, then start the bridge as a background process:

```bash
mkdir -p logs
```

Start the bridge using the service script:

```bash
./scripts/start_bridge.sh &
```

Wait a few seconds, then verify it started:

```bash
sleep 4 && tail -20 logs/bridge.log 2>/dev/null
```

Check for these indicators in the logs:
- `Agent backend: Claude Agent SDK` — correct backend
- `Active projects: [...]` — the projects you configured
- `Monitored groups: [...]` — the Telegram groups
- `Connected to Telegram` — successful connection

Also verify the process is running:

```bash
pgrep -f telegram_bridge.py
```

## Step 7: Confirm to User

Report the final status to the user with:

- **Bridge status**: Running (with PID)
- **Agent backend**: Claude Agent SDK
- **Active projects**: Which projects are configured
- **Monitored groups**: Which Telegram groups are being watched
- **Next step**: "Send a test message in the Telegram group to verify it responds"

Example:

> Setup complete. The bridge is running in the background.
>
> - PID: 12345
> - Backend: Claude Agent SDK
> - Monitoring: "Dev: PsyOPTIMAL" (psyoptimal project)
>
> Send a test message in the group to verify it responds.

## Rules

- **You** do everything: deps, config, starting the bridge, verification
- **User** only does the interactive Telegram login (Step 4)
- Never ask the user to start the bridge or check logs — do it yourself
- Never set `respond_to_all: false` in project configs
- Always include the `defaults` section in `projects.json`
- Always verify `working_directory` paths exist on disk before starting
- The bridge must be confirmed running before you report success
- If anything fails, debug it yourself. Only escalate to the user if it requires their credentials or interactive input.
