---
description: Configure a new machine to run the Valor Telegram bridge with all dependencies, authentication, and service startup
---

# Setup - New Machine Configuration

Configure this machine to run the Valor Telegram bridge. You do everything except the interactive Telegram login step.

## Prerequisites

Before starting, confirm the user has:
- Python 3.11+ installed
- The `ai` repo cloned at `/Users/valorengels/src/ai`
- Telegram API credentials (api_id and api_hash from https://my.telegram.org). If they don't have these, pause and explain how to get them before continuing.

## Step 1: Install uv Package Manager

We use `uv` for fast, reliable Python package management (much faster than pip).

```bash
# Check if uv is already installed
if ! command -v uv &> /dev/null; then
  echo "Installing uv package manager..."
  curl -LsSf https://astral.sh/uv/install.sh | sh
  export PATH="$HOME/.local/bin:$PATH"
fi

# Verify installation
uv --version
```

## Step 2: Virtual Environment & Dependencies

```bash
cd /Users/valorengels/src/ai

# Create virtual environment with uv (auto-creates with pip support)
uv venv

# Sync all dependencies including dev tools from pyproject.toml
uv sync --all-extras

# Install package in editable mode (registers CLI tools)
uv pip install -e .
```

This will:
- Create `.venv/` with Python 3.12 (or latest)
- Install all dependencies including:
  - Telegram bridge (telethon, httpx)
  - Claude SDK integration (anthropic, claude-agent-sdk)
  - Google Calendar (google-auth-oauthlib, google-api-python-client)
  - Job queue (popoto, redis)
  - Summarization (ollama)
  - Dev tools (pytest, ruff, mypy)
- Register CLI tools (`valor-calendar`, `valor-history`)

Verify key imports work:

```bash
.venv/bin/python -c "import telethon; import httpx; import dotenv; import anthropic; import google_auth_oauthlib; print('Dependencies OK')"
```

If this fails, debug before continuing.

## Step 3: Environment File (.env)

Check if `.env` exists. If not:

```bash
cp .env.example .env
```

**Ask the user** which project(s) this machine should monitor. The available projects are defined in `config/projects.json` — check the full list there. Common options:
- Single project: `ACTIVE_PROJECTS=psyoptimal`
- Multiple: `ACTIVE_PROJECTS=valor,popoto`
- All: `ACTIVE_PROJECTS=valor,django-project-template,popoto,psyoptimal,flutter-project-template,cuttlefish,yudame-research`

Edit `.env` and ensure these are set:

| Variable | Required | Notes |
|----------|----------|-------|
| `ACTIVE_PROJECTS` | Yes | Comma-separated project keys |
| `USE_CLAUDE_SDK` | Yes | Must be `true` |
| `ANTHROPIC_API_KEY` | Yes | Starts with `sk-ant-` |
| `TELEGRAM_API_ID` | Yes | Numeric, from my.telegram.org |
| `TELEGRAM_API_HASH` | Yes | Hex string, from my.telegram.org |
| `TELEGRAM_PHONE` | Yes | With country code, e.g. `+1234567890` |
| `TELEGRAM_PASSWORD` | If 2FA on | Telegram 2FA password |
| `TELEGRAM_SESSION_NAME` | No | Defaults to `valor_bridge` |
| `TELEGRAM_DM_WHITELIST` | No | Comma-separated names, e.g. `Tom` |

If any required values are placeholder/missing, ask the user to provide them. The shared API keys file at `/Users/valorengels/src/.env` may have `ANTHROPIC_API_KEY` and other keys — check there first.

## Step 4: Google Calendar Configuration

Set up Google Calendar integration for work time tracking.

### 4.1 Get Google OAuth credentials

Check if credentials exist:

```bash
ls ~/Desktop/claude_code/google_credentials.json
```

If missing, ask the user to:
1. Go to Google Cloud Console (project: Yudame General)
2. Enable Google Calendar API
3. Create OAuth 2.0 Client ID (Desktop app)
4. Download JSON and save to `~/Desktop/claude_code/google_credentials.json`

### 4.2 Run OAuth consent flow

Check if token already exists:

```bash
ls ~/Desktop/claude_code/google_token.json 2>/dev/null
```

If no token exists, run the OAuth flow:

```bash
cd /Users/valorengels/src/ai

# This will open browser for Google OAuth consent
.venv/bin/valor-calendar test

# Or use the CLI directly
.venv/bin/python -c "
from tools.google_workspace.auth import get_service
service = get_service('calendar', 'v3')
print('OAuth flow complete, token saved')
"
```

The user must complete the OAuth consent in their browser. After completion, verify the token was created:

```bash
ls ~/Desktop/claude_code/google_token.json
```

### 4.3 Create calendar mappings

The calendar config is auto-generated by the `/update` command. For now, ensure the Google Calendars exist with matching names:

**Required calendars in Google Calendar:**
- **"Internal Projects"** (default for Claude Code sessions and internal projects)
- Optional: Create dedicated calendars for client projects that need separate time tracking
  - Example: For "Dev: PsyOPTIMAL" group → create "PsyOPTIMAL" calendar
  - Internal projects (valor, popoto, flutter-template, etc.) use the default calendar

After setup, run `/update` to auto-generate `~/Desktop/claude_code/calendar_config.json`.

## Step 5: Authentication Configuration

The SDK uses Max subscription OAuth via the Claude Desktop app (no API credits needed).

```bash
# Check if Claude Desktop app is running (provides OAuth for CLI)
if pgrep -f "Claude.app" > /dev/null; then
  echo "✅ Claude Desktop is running (provides subscription auth)"
else
  echo "⚠️  Claude Desktop is not running"
  echo "Start /Applications/Claude.app to enable subscription auth"
  echo "Without it, the bridge will fall back to API key billing"
fi

# Verify API key exists as fallback
if grep -q 'ANTHROPIC_API_KEY=sk-ant-' .env 2>/dev/null; then
  echo "✅ API key configured (fallback if Desktop auth fails)"
else
  echo "⚠️  No API key fallback configured"
fi
```

**How authentication works:**
- **Primary**: Claude Desktop app (if running) provides OAuth authentication
- **Fallback**: API key from `.env` (`ANTHROPIC_API_KEY`)
- **Force API billing**: Set `USE_API_BILLING=true` in `.env`

The SDK spawns Claude Code CLI subprocesses that inherit authentication from the running Claude Desktop app. No separate login command is needed.

## Step 6: Project Configuration (config/projects.json)

Check if `config/projects.json` exists. If not:

```bash
cp config/projects.json.example config/projects.json
```

Edit `config/projects.json` for this machine's projects.

**Critical rules when editing projects.json:**

1. **Every project MUST have `working_directory`** — absolute path to the repo on this machine
2. **Always include the full `defaults` section** — copy it from the example if missing
3. **DO NOT set `respond_to_all: false`** — the default is `true`, which is correct. Omit the field entirely from project-level telegram config.
4. **Keep project telegram config minimal** — usually just `"groups": ["Dev: ProjectName"]` is sufficient
5. **Verify paths exist on disk** — run `ls` on each `working_directory` to confirm

Example minimal project entry:

```json
{
  "projects": {
    "myproject": {
      "name": "My Project",
      "working_directory": "/Users/valorengels/src/myproject",
      "telegram": {
        "groups": ["Dev: My Project"]
      },
      "github": {
        "org": "orgname",
        "repo": "reponame"
      },
      "context": {
        "tech_stack": ["Python"],
        "description": "What the agent should focus on"
      }
    }
  },
  "defaults": {
    "working_directory": "/Users/valorengels/src/ai",
    "telegram": {
      "respond_to_all": true,
      "respond_to_mentions": true,
      "respond_to_dms": true,
      "mention_triggers": ["@valor", "valor", "hey valor"]
    },
    "response": {
      "typing_indicator": true,
      "max_response_length": 4000,
      "timeout_seconds": 300
    }
  }
}
```

If the project is already defined in the main repo's `config/projects.json`, copy its entry rather than writing from scratch. The canonical project list is in the main repo on the `main` branch.

After editing, verify all working directories exist:

```bash
# For each project's working_directory, confirm it exists
ls /Users/valorengels/src/<project_dir>
```

## Step 7: Telegram Login (USER ACTION REQUIRED)

Check for an existing session:

```bash
ls data/*.session 2>/dev/null
```

**If a session file exists**: Skip to Step 8.

**If no session file exists**: The user must complete an interactive login. Tell them:

> I've finished all the automated setup. One step requires your input — the Telegram login sends a verification code to your phone.
>
> Please run this in a terminal:
> ```
> cd /Users/valorengels/src/ai && source .venv/bin/activate && python scripts/telegram_login.py
> ```
> Let me know when you're done.

**STOP HERE. Do not proceed until the user confirms the login is complete.**

After they confirm, verify the session was created:

```bash
ls data/*.session
```

If no session file appeared, something went wrong. Ask the user what happened and help debug.

## Step 8: Start the Bridge

Ensure the logs directory exists, then start the bridge as a background process:

```bash
mkdir -p logs
```

Start the bridge using the service script:

```bash
./scripts/valor-service.sh start
```

Wait a few seconds, then verify it started:

```bash
sleep 4 && tail -20 logs/bridge.log 2>/dev/null
```

Check for these indicators in the logs:
- `Agent backend: Claude Agent SDK` — correct backend
- `Active projects: [...]` — the projects you configured
- `Monitored groups: [...]` — the Telegram groups
- `Connected to Telegram` — successful connection

Also verify the process is running:

```bash
pgrep -f telegram_bridge.py
```

## Step 9: Final Verification

Run a comprehensive health check:

```bash
cd /Users/valorengels/src/ai

echo "=== System Tools ==="
claude --version
gh --version
git --version
uv --version

echo ""
echo "=== Python Environment ==="
.venv/bin/python --version
.venv/bin/python -c "import telethon; import anthropic; import google_auth_oauthlib; print('Dependencies OK')"

echo ""
echo "=== CLI Tools ==="
.venv/bin/valor-calendar --version 2>/dev/null || echo "valor-calendar: Not found (run 'uv pip install -e .' again)"
.venv/bin/python -m tools.sms_reader.cli recent --limit 1 | grep -q "rowid" && echo "SMS reader: OK" || echo "SMS reader: FAIL"

echo ""
echo "=== Bridge Status ==="
./scripts/valor-service.sh status
```

## Step 10: Confirm to User

Report the final status to the user with:

- **Bridge status**: Running (with PID)
- **Agent backend**: Claude Agent SDK
- **Active projects**: Which projects are configured
- **Monitored groups**: Which Telegram groups are being watched
- **Next steps**:
  1. Send a test message in the Telegram group to verify it responds
  2. Run `/update` to generate calendar config

Example:

> Setup complete. The bridge is running in the background.
>
> - PID: 12345
> - Backend: Claude Agent SDK
> - Monitoring: "Dev: PsyOPTIMAL" (psyoptimal project)
>
> Next steps:
> 1. Send a test message in the group to verify it responds
> 2. Run `/update` to auto-generate calendar config from your Google Calendars

## Rules

- **You** do everything: deps, config, starting the bridge, verification
- **User** only does:
  1. Interactive Telegram login (Step 7)
  2. Claude login (if not already done)
  3. Google OAuth consent (if no token exists)
- Never ask the user to start the bridge or check logs — do it yourself
- Never set `respond_to_all: false` in project configs
- Always include the `defaults` section in `projects.json`
- Always verify `working_directory` paths exist on disk before starting
- The bridge must be confirmed running before you report success
- If anything fails, debug it yourself. Only escalate to the user if it requires their credentials or interactive input.

## Troubleshooting

### uv not found after install
```bash
export PATH="$HOME/.local/bin:$PATH"
echo 'export PATH="$HOME/.local/bin:$PATH"' >> ~/.zshrc
```

### Dependencies won't install
```bash
rm -rf .venv
uv venv
uv sync --all-extras
```

### Calendar OAuth fails
1. Verify credentials file exists: `ls ~/Desktop/claude_code/google_credentials.json`
2. Ensure Google Calendar API is enabled in Cloud Console
3. Re-run OAuth: `.venv/bin/valor-calendar test`

### Bridge won't start
1. Check logs: `tail -50 logs/bridge.log`
2. Verify Telegram session: `ls data/*.session`
3. Test imports: `.venv/bin/python -c "import telethon; print('OK')"`
